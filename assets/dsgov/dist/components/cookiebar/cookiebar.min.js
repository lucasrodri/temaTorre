import h from"../../partial/js/behavior/checkgroup";import{CookiebarData as l}from"./cookiebar-data";import{CookiebarTemplates as d}from"./cookiebar-templates";import*as u from"./selectors";export default class m{constructor({name:e,component:t,json:o,lang:s,mode:i="default",callback:a}){this.name=e,this.component=t,this.data=new l(o,s),this.templates=new d(this.data),this.mode=i,this.callback=a,this._setUp()}_setUp(){this._buildCookiebar(),this._setBehavior(),this._showCookiebar()}_buildCookiebar(){this.component.innerHTML=this.templates.setGlobalContentArea()}_setBehavior(){this._setAcceptButtonBehavior(),this._setPoliticsButtonBehavior(),this._setCloseButtonBehavior(),this._setToggleGroupBehavior(),this._setCheckboxBehavior(),this._setSelectionBehavior(),this._setWindowResizeBehavior()}_setAcceptButtonBehavior(){const e=this.component.querySelector(u.ACCEPT_BUTTON);e.addEventListener("click",()=>{this._hideCookiebar(),document.body.style.overflowY="auto",this.callback(this._setOutputJSON())}),e.addEventListener("keydown",e=>{"Tab"===e.key&&(this.component.classList.contains("default")||this.component.focus())}),this._setActionButtonResponsive(e)}_setPoliticsButtonBehavior(){this.component.querySelectorAll(u.POLITICS_BUTTON).forEach(e=>{e.addEventListener("click",()=>{e.classList.add("d-none"),this.component.classList.remove("default"),this.component.focus(),document.body.style.overflowY="hidden",this._setOpenView()}),this._setActionButtonResponsive(e)})}_setCloseButtonBehavior(){this.component.querySelectorAll(u.CLOSE_BUTTON).forEach(e=>{e.addEventListener("click",()=>{switch(this.component.classList.add("default"),this.mode){case"open":this._hideCookiebar()}this.component.querySelector(u.POLITICS_BUTTON).classList.remove("d-none"),document.body.style.overflowY="auto",this._setDefaultView()})})}_setWindowResizeBehavior(){window.addEventListener("resize",()=>{this.component.classList.contains("default")||this._setOpenView(),this.component.querySelectorAll(u.ACTION_BUTTONS).forEach(e=>{this._setActionButtonResponsive(e)})})}_setActionButtonResponsive(e){window.matchMedia("(max-width: 574px)").matches&&e.classList.add("block"),window.matchMedia("(min-width: 575px)").matches&&e.classList.remove("block")}_setToggleGroupBehavior(){this.component.querySelectorAll(`${u.GROUP_BUTTON}, ${u.GROUP_NAME}, ${u.COOKIES_CHECKED}, ${u.GROUP_SIZE}`).forEach(e=>{e.addEventListener("click",this._handleToggleGroupClick.bind(this))})}_handleToggleGroupClick(e){const t=this._getParentElementByClass(e.currentTarget,"br-item");t.classList.contains("open")?(t.classList.remove("open"),t.nextElementSibling.querySelectorAll(u.BR_SWITCH).forEach(e=>{e.setAttribute("tabindex",-1)}),this._setGroupAttributes(t,"Expandir"),this._toggleIcon(t,"fa-angle-up","fa-angle-down")):(t.classList.add("open"),t.nextElementSibling.querySelectorAll(u.BR_SWITCH).forEach(e=>{e.setAttribute("tabindex",0)}),this._setGroupAttributes(t,"Retrair"),this._toggleIcon(t,"fa-angle-down","fa-angle-up"),this._scrollUp(t))}_setCheckboxBehavior(){this.component.querySelectorAll(u.PARENT_CHECKBOX).forEach(e=>{this.checkgroupBehavior=new h(e),this.checkgroupBehavior.setBehavior()})}_setSelectionBehavior(){this.component.querySelectorAll(u.CHECKBOX).forEach(e=>{e.addEventListener("change",this._controlSelection.bind(this))})}_controlSelection(e){const t=e.currentTarget.id.split("-");switch(t[1]){case"all":this._setCheckAllBehavior(e.currentTarget);break;case"group":this._setCheckgroupBehavior(e.currentTarget,t[2]);break;case"cookie":this._setCheckCookieBehavior(e.currentTarget,t[2],t[3])}}_setCheckAllBehavior(e){this.data.selectAll=e.checked,this.data.allIndeterminated=!!e.hasAttribute("indeterminate"),this._displayBroadAlertMessage()}_setCheckgroupBehavior(e,t){this.data.cookieGroups[t].groupSelected=e.checked,this.data.cookieGroups[t].groupIndeterminated=!!e.hasAttribute("indeterminate"),this.data.cookieGroups[t].cookieList.forEach((o,s)=>{o.cookieOptOut||(o.cookieSelected=e.checked,this._displayCookieAlertMessage(t,s))}),this._displayGroupAlertMessage(t)}_setCheckCookieBehavior(e,t,o){this.data.cookieGroups[t].cookieList[o].cookieSelected=e.checked,this._displayCookieAlertMessage(t,o)}_displayBroadAlertMessage(){this.component.querySelectorAll(u.BROAD_ALERT).forEach(e=>{!this.data.allAlertMessage||this.data.selectAll&&!this.data.allIndeterminated?e.classList.add("d-none"):e.classList.remove("d-none")})}_displayGroupAlertMessage(e){this.component.querySelectorAll(u.GROUP_INFO)[e].querySelectorAll(u.GROUP_ALERT).forEach(t=>{!this.data.cookieGroups[e].groupAlertMessage||this.data.cookieGroups[e].groupSelected&&!this.data.cookieGroups[e].groupIndeterminated?t.classList.add("d-none"):t.classList.remove("d-none")})}_displayCookieAlertMessage(e,t){this.component.querySelectorAll(u.GROUP_INFO)[e].nextElementSibling.querySelectorAll(u.COOKIE_CARD)[t].querySelectorAll(u.COOKIE_ALERT).forEach(o=>{this.data.cookieGroups[e].cookieList[t].alertMessage&&!this.data.cookieGroups[e].cookieList[t].cookieSelected?o.classList.remove("d-none"):o.classList.add("d-none")})}_getParentElementByClass(e,t){for(;!e.classList.contains(t);)e=e.parentNode;return e}_toggleIcon(e,t,o){e.querySelectorAll(u.BUTTON_ICON).forEach(e=>{e.classList.remove(t),e.classList.add(o)})}_setGroupAttributes(e,t){e.querySelectorAll(`${u.GROUP_BUTTON}, ${u.GROUP_NAME}, ${u.COOKIES_CHECKED}, ${u.GROUP_SIZE}`).forEach(e=>{e.setAttribute("title",t),e.setAttribute("aria-label",t)})}_scrollUp(e){setTimeout(()=>{this.component.querySelectorAll(u.WRAPPER).forEach(()=>{setTimeout(()=>{e.scrollIntoView({behavior:"smooth",block:"start"})},150)},5e3)})}_showCookiebar(){switch(this.component.classList.remove("d-none"),this.component.focus(),this.mode){case"open":this.component.classList.remove("default"),this.component.querySelectorAll(u.POLITICS_BUTTON).forEach(e=>{e.classList.add("d-none")}),document.body.style.overflowY="hidden",this._setOpenView()}}_hideCookiebar(){this.component.classList.add("d-none")}_setOpenView(){const e=this.component.querySelector(u.WRAPPER),t=this.component.querySelector(u.CONTAINER_FLUID),o=this.component.querySelector(u.MODAL_FOOTER),s=window.getComputedStyle(t,null).getPropertyValue("padding-top").match(/\d+/),i=window.innerHeight-2*s-o.offsetHeight+"px";e.style.height=i}_setDefaultView(){this.component.querySelector(u.WRAPPER).removeAttribute("style")}_setOutputJSON(){return this.output={},this.output.selectAll=this.data.allIndeterminated?"indeterminated":this.data.selectAll,this.output.cookieGroups=[],this.data.cookieGroups.forEach(e=>{const t=[];e.cookieList.forEach(e=>{t.push({cookieId:e.cookieId,cookieSelected:e.cookieSelected})}),this.output.cookieGroups.push({groupId:e.groupId,groupSelected:e.groupIndeterminated?"indeterminated":e.groupSelected,cookieList:t})}),JSON.stringify(this.output)}static createCookiebar(e,t){const o=document.createElement("div");o.classList.add("br-cookiebar","default","d-none"),o.setAttribute("tabindex",1),document.body.appendChild(o);return new m({name:"br-cookiebar",component:o,lang:"pt-br",mode:"default",json:e,callback:t})}}